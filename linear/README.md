# Linear

線形型を試す

## 抽象構文

```
    型 T :=
        int
        | unit
        | ( T )         カッコ
        | T * T         ペア
        | T -> T        関数型
        | __linear<T>   線形型 [^lin]

    パターン P :=
        ident           識別子
        | _             ワイルドカード
        | ( P )         カッコ
        | P, P          ペア
        | ident P       バリアント分解

    式 E :=
        number          数値リテラル
        | ( E )         カッコ式
        | E ; E         順次
        | E E           関数適用
        | E, E          ペア
        | E + E         加算
        | E = E         等価性の比較
        | let P = E     束縛
        | if E then E   分岐
               else E
          end
        | assert E      表明
        | __acquire E   線形獲得
        | __dispose E   線形破棄

    宣言 D :=
        let ident params* : T = E   関数宣言
        | expect string { E }       成功テスト
        | expect_error string { E } 失敗テスト
```

### 関数宣言

関数宣言の構文は F# と同様。ただし型注釈は必須

`let ident param1 param2 ... : result = E`

本体が1行のとき

```fs
let f1 (x: int) (y: int) : int = x + y
```

本体が複数行のとき

```fs
let f2 (x: int) (y: int) : int = {
    let xx = x * x
    let yy = y * y
    xx + yy
}
```

### expect宣言

`expect "タイトル" { 本体 }`

本体の式の評価が正常に完了することを表す

### expect_error宣言

`expect_error "タイトル" { 本体 }`

本体の式の型検査が通らないことを表す

### 線形型のためのプリミティブ

- `__linear<'T>`
    - ビルトインの線形型。`'T` 型の値をラップしたもの
- `__acquire<'T>` : `'T -> __linear<'T>`
    - 任意の値をラップして `__linear` 型を作る
    - unsafe操作
- `__dispose<'T>` : `__linear<'T> -> 'T`
    - `__linear` 型の値を破棄して中身を取り出す
    - unsafe操作

----

## 余談: 具象構文

具象構文は F# をベースにしつつ、レイアウトルールを排除したかたちになっている

### 自動セミコロン挿入

字句解析の後、行末が特定の種類のトークンである行の末尾に ';' を挿入する。対象となるトークンの種類は式の末尾になりうるもの:

- 数値、識別子、`end`, `)`, `}`

(Go言語と同様の仕組み)

### 節

一部の式は節 (clause) という構文になっている。これは式を `;` 区切りにしたもので、前後の冗長な `;` も無視される

`()` の内部、if式のthen節・else節の部分は節になっている

### let式とブロック

伝統的なML系の言語と異なり、`let` は `in` 節を持たない。代わりに、ブロック (カッコ式) の内部にlet式を配置し、後続の式で変数を使う

`let` 自体は `()` に評価される。`let` はブロックの内部にだけ出現できる

ブロックを評価した値は、節が空なら `()` (ユニット)、空でなければ最後の式を評価した値に等しい

(Rustのlet文と同様の仕組み。ただしRustと違って、最後の式の後に `;` がついていても、その式の値がブロックの値になる)
